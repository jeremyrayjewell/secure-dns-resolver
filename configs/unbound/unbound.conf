# Private DNS resolver with DNSSEC + DNS-over-TLS (DoT)
#
# Design goals:
# - Private (NOT an open resolver): listen only on localhost by default, and enforce ACLs.
# - DNSSEC validation enabled.
# - DoT enabled on port 853 with a local CA-signed server certificate.
# - Minimal, auditable settings; security hardening focuses on safe defaults.
#
# NOTE: This config is intended for local testing first.
# For LAN use, change the interface and access-control sections as documented.

server:
  ###########################################################################
  # Core behavior (recursive resolver + DNSSEC)
  ###########################################################################

  # Unbound uses the "validator" and "iterator" modules by default.
  # - iterator: does recursive resolution from the root
  # - validator: performs DNSSEC validation and sets AD bit for secure answers
  module-config: "validator iterator"
  # Force IPv4 only. Windows often has broken/partial IPv6 that causes timeouts.
  do-ip4: yes
  do-ip6: no

  # Track the DNS root trust anchor using RFC 5011 auto-updates.
  # You MUST bootstrap this file initially using `unbound-anchor -a root.key`.
  # Unbound needs write access to update it over time.
  auto-trust-anchor-file: "var/root.key"

  # Use an external root hints file rather than built-in hints.
  # This makes updates explicit/auditable and avoids stale built-ins.
  root-hints: "var/root.hints"

  ###########################################################################
  # Listening interfaces (prevent open resolver)
  ###########################################################################

  # If no `interface:` is set, Unbound defaults to localhost.
  # We keep this explicit for clarity.

  # Plain DNS (UDP/TCP) on localhost only (port 53).
  interface: 127.0.0.1
  interface: ::1

  # DNS-over-TLS (DoT) on localhost only (port 853).
  # Only interfaces configured with @853 get TLS service.
  interface: 127.0.0.1@853
  interface: ::1@853

  # IMPORTANT (LAN use): if you want your own client machines on your LAN to
  # query this resolver over DoT, add your LAN IP here, for example:
  #   interface: 192.0.2.10@853
  # and then allow only your client IP(s) via access-control below.

  # Port for plaintext DNS responses (default 53).
  port: 53

  ###########################################################################
  # Access control (the key to “not an open resolver”)
  ###########################################################################

  # Unbound chooses the most specific matching rule. If nothing matches, it
  # REFUSES by default.
  # We add explicit defaults for clarity.

  # Allow localhost (already implicitly allowed, but explicit is clearer).
  access-control: 127.0.0.0/8 allow
  access-control: ::1 allow

  # Default: refuse everyone else (prevents accidental exposure).
  access-control: 0.0.0.0/0 refuse
  access-control: ::0/0 refuse

  # Additional allow rules are injected at runtime (e.g., container deployment).
  include: "/data/access-control.conf"

  # To allow ONE client IP (example), add a more specific rule:
  #   access-control: 192.0.2.50/32 allow
  # or allow your whole LAN CIDR if you truly control it:
  #   access-control: 192.0.2.0/24 allow
  # Security note: prefer allowing specific client IPs over whole subnets.

  ###########################################################################
  # DNS-over-TLS service (downstream: clients -> this Unbound)
  ###########################################################################

  # Enabling tls-service-key/pem turns on DoT service on @tls-port interfaces.
  # The certificate must be PEM and include SANs matching how clients connect
  # (IP address and/or DNS name).
  tls-service-key: "/data/server.key"
  tls-service-pem: "/data/server.pem"

  # DoT port. Default is 853; explicit for auditability.
  tls-port: 853

  ###########################################################################
  # Sensible security hardening (conservative)
  ###########################################################################

  # Reduce information leakage.
  hide-identity: yes
  hide-version: yes
  hide-trustanchor: yes

  # Require DNSSEC when a trust anchor exists (defends against DNSSEC stripping).
  harden-dnssec-stripped: yes

  # Basic query/response hardening.
  harden-glue: yes
  harden-short-bufsize: yes
  deny-any: yes
  minimal-responses: yes

  # Privacy improvements for iterative resolution.
  qname-minimisation: yes

  # Mitigate DNS rebinding by stripping RFC1918/ULA/link-local answers for
  # public names. If you host internal split-horizon names, use private-domain.
  private-address: 10.0.0.0/8
  private-address: 172.16.0.0/12
  private-address: 192.168.0.0/16
  private-address: 169.254.0.0/16
  private-address: fd00::/8
  private-address: fe80::/10

  ###########################################################################
  # Logging (keep it simple)
  ###########################################################################

  verbosity: 1
  logfile: "var/unbound.log"

  ###########################################################################
  # Performance defaults
  ###########################################################################

  # For a small private resolver, 1 thread is fine and easier to reason about.
  num-threads: 1
